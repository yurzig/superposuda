<?php

namespace App\Http\Controllers;

use RetailCrm\Api\Factory\SimpleClientFactory;
use RetailCrm\Api\Interfaces\ApiExceptionInterface;
use RetailCrm\Api\Interfaces\ClientExceptionInterface;
use RetailCrm\Api\Model\Entity\Orders\Items\Offer;
use RetailCrm\Api\Model\Entity\Orders\Items\OrderProduct;
use RetailCrm\Api\Model\Entity\Orders\Order;
use RetailCrm\Api\Model\Request\Orders\OrdersCreateRequest;

class RetailCrmController extends Controller
{
    /**
     * API заказ RetailCrm
     *
     * @return \Illuminate\Http\Response
     */
    public function orderNew()
    {

        $client = SimpleClientFactory::createClient('https://superposuda.retailcrm.ru', 'QlnRWTTWw9lv3kjxy1A8byjUmBQedYqb');

        $request = new OrdersCreateRequest();
        $order = new Order();
//        $payment         = new Payment();
//        $delivery        = new SerializedOrderDelivery();
//        $deliveryAddress = new OrderDeliveryAddress();
        $offer = new Offer();
        $item = new OrderProduct();

//        $payment->type   = 'bank-card';
//        $payment->status = 'paid';
//        $payment->amount = 1000;
//        $payment->paidAt = new DateTime();
//
//        $deliveryAddress->index      = '344001';
//        $deliveryAddress->countryIso = CountryCodeIso3166::RUSSIAN_FEDERATION;
//        $deliveryAddress->region     = 'Region';
//        $deliveryAddress->city       = 'City';
//        $deliveryAddress->street     = 'Street';
//        $deliveryAddress->building   = '10';
//
//        $delivery->address = $deliveryAddress;
//        $delivery->cost    = 0;
//        $delivery->netCost = 0;
//
        $offer->name = 'Azalita';
        $offer->displayName = 'Azalita';
//        $offer->xmlId       = 'tGunLo27jlPGmbA8BrHxY2';
        $offer->article = 'AZ105R';
//        $offer->unit        = new Unit('796', 'Piece', 'pcs');
//
        $item->offer = $offer;
//        $item->priceType     = new PriceType('base');
//        $item->quantity      = 1;
//        $item->purchasePrice = 60;
        $item->productName = 'Маникюрный набор AZ105R Azalita';

//        $order->delivery      = $delivery;
        $order->items = [$item];
//        $order->payments      = [$payment];
        $order->orderType = 'fizik';
        $order->orderMethod = 'test';
        $order->number = '14041961';
//        $order->countryIso    = CountryCodeIso3166::RUSSIAN_FEDERATION;
        $order->firstName = 'Юрий';
        $order->lastName = 'Зиганьшин';
//        $order->patronymic    = 'Patronymic';
//        $order->phone         = '89003005069';
//        $order->email         = 'testuser12345678901@example.com';
//        $order->managerId     = 28;
//        $order->customer      = SerializedRelationCustomer::withIdAndType(
//            4924,
//            CustomerType::CUSTOMER
//        );
        $order->status = 'trouble';
//        $order->statusComment = 'Assembling order';
//        $order->weight        = 1000;
//        $order->shipmentStore = 'main12';
//        $order->shipmentDate  = (new DateTime())->add(new DateInterval('P7D'));
        $order->customerComment = 'https://github.com/yurzig/superposuda/blob/main/RetailCrmController';
        $order->customFields = [
            "prim" => 'тестовое задание',
        ];

        $request->order = $order;
        $request->site = 'test';

        try {
            $response = $client->orders->create($request);
        } catch (ApiExceptionInterface | ClientExceptionInterface $exception) {
            echo $exception; // Every ApiExceptionInterface instance should implement __toString() method.
            exit(-1);
        }

        printf(
            'Created order id = %d with the following data: %s',
            $response->id,
            print_r($response->order, true)
        );
    }
}
